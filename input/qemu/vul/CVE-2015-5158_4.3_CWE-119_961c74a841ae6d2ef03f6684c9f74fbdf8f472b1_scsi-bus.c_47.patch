--- CVE-2015-5158_4.3_CWE-119_961c74a841ae6d2ef03f6684c9f74fbdf8f472b1_scsi-bus.c_47_OLD.vul	2020-05-20 08:51:09.290585801 -0400
+++ CVE-2015-5158_4.3_CWE-119_961c74a841ae6d2ef03f6684c9f74fbdf8f472b1_scsi-bus.c_47_NEW.vul	2020-05-20 08:51:09.290585801 -0400
@@ -1,10 +1,15 @@
 int scsi_req_parse_cdb(SCSIDevice *dev, SCSICommand *cmd, uint8_t *buf)
 {
     int rc;
+    int len;
 
     cmd->lba = -1;
-    cmd->len = scsi_cdb_length(buf);
+    len = scsi_cdb_length(buf);
+    if (len < 0) {
+        return -1;
+    }
 
+    cmd->len = len;
     switch (dev->type) {
     case TYPE_TAPE:
         rc = scsi_req_stream_xfer(cmd, dev, buf);
