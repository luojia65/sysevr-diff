--- CVE-2017-7493_4.6_CWE-732_7a95434e0ca8a037fd8aa1a2e2461f92585eb77b_9p-local.c_42_OLD.vul	2020-05-20 08:48:04.009480627 -0400
+++ CVE-2017-7493_4.6_CWE-732_7a95434e0ca8a037fd8aa1a2e2461f92585eb77b_9p-local.c_42_NEW.vul	2020-05-20 08:48:04.009480627 -0400
@@ -5,6 +5,13 @@
     int ret;
     int odirfd, ndirfd;
 
+    if (ctx->export_flags & V9FS_SM_MAPPED_FILE &&
+        (local_is_mapped_file_metadata(ctx, old_name) ||
+         local_is_mapped_file_metadata(ctx, new_name))) {
+        errno = EINVAL;
+        return -1;
+    }
+
     odirfd = local_opendir_nofollow(ctx, olddir->data);
     if (odirfd == -1) {
         return -1;
