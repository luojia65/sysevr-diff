--- CVE-2013-4534_7.5_CWE-119_609f5bf6fecb78ada914b88598ae8ba43e304e36_openpic.c_38_OLD.vul	2020-05-20 08:34:00.496491591 -0400
+++ CVE-2013-4534_7.5_CWE-119_609f5bf6fecb78ada914b88598ae8ba43e304e36_openpic.c_38_NEW.vul	2020-05-20 08:34:00.496491591 -0400
@@ -1,7 +1,7 @@
 static int openpic_load(QEMUFile* f, void *opaque, int version_id)
 {
     OpenPICState *opp = (OpenPICState *)opaque;
-    unsigned int i;
+    unsigned int i, nb_cpus;
 
     if (version_id != 1) {
         return -EINVAL;
@@ -13,7 +13,11 @@
     qemu_get_be32s(f, &opp->spve);
     qemu_get_be32s(f, &opp->tfrr);
 
-    qemu_get_be32s(f, &opp->nb_cpus);
+    qemu_get_be32s(f, &nb_cpus);
+    if (opp->nb_cpus != nb_cpus) {
+        return -EINVAL;
+    }
+    assert(nb_cpus > 0 && nb_cpus <= MAX_CPU);
 
     for (i = 0; i < opp->nb_cpus; i++) {
         qemu_get_sbe32s(f, &opp->dst[i].ctpr);
