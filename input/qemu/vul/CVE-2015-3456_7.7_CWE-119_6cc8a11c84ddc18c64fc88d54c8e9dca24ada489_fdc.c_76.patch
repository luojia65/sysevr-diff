--- CVE-2015-3456_7.7_CWE-119_6cc8a11c84ddc18c64fc88d54c8e9dca24ada489_fdc.c_76_OLD.vul	2020-05-20 08:47:17.019229251 -0400
+++ CVE-2015-3456_7.7_CWE-119_6cc8a11c84ddc18c64fc88d54c8e9dca24ada489_fdc.c_76_NEW.vul	2020-05-20 08:47:17.019229251 -0400
@@ -24,6 +24,10 @@
     pos %= FD_SECTOR_LEN;
     fdctrl->fifo[pos] = value;
 
+    if (fdctrl->data_pos == fdctrl->data_len) {
+        fdctrl->msr &= ~FD_MSR_RQM;
+    }
+
     switch (fdctrl->phase) {
     case FD_PHASE_EXECUTION:
         /* For DMA requests, RQM should be cleared during execution phase, so
@@ -62,6 +66,9 @@
              * as many parameters as this command requires. */
             cmd = get_command(value);
             fdctrl->data_len = cmd->parameters + 1;
+            if (cmd->parameters) {
+                fdctrl->msr |= FD_MSR_RQM;
+            }
             fdctrl->msr |= FD_MSR_CMDBUSY;
         }
 
