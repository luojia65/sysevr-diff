--- CVE-2014-0147_0.0_CWE-000_b106ad9185f35fc4ad669555ad0e79e276083bd7_qcow2.c_26_OLD.vul	2020-05-20 08:35:50.176721287 -0400
+++ CVE-2014-0147_0.0_CWE-000_b106ad9185f35fc4ad669555ad0e79e276083bd7_qcow2.c_26_NEW.vul	2020-05-20 08:35:50.176721287 -0400
@@ -29,7 +29,7 @@
      */
     BlockDriverState* bs;
     QCowHeader *header;
-    uint8_t* refcount_table;
+    uint64_t* refcount_table;
     Error *local_err = NULL;
     int ret;
 
@@ -81,9 +81,10 @@
         goto out;
     }
 
-    /* Write an empty refcount table */
-    refcount_table = g_malloc0(cluster_size);
-    ret = bdrv_pwrite(bs, cluster_size, refcount_table, cluster_size);
+    /* Write a refcount table with one refcount block */
+    refcount_table = g_malloc0(2 * cluster_size);
+    refcount_table[0] = cpu_to_be64(2 * cluster_size);
+    ret = bdrv_pwrite(bs, cluster_size, refcount_table, 2 * cluster_size);
     g_free(refcount_table);
 
     if (ret < 0) {
@@ -108,7 +109,7 @@
         goto out;
     }
 
-    ret = qcow2_alloc_clusters(bs, 2 * cluster_size);
+    ret = qcow2_alloc_clusters(bs, 3 * cluster_size);
     if (ret < 0) {
         error_setg_errno(errp, -ret, "Could not allocate clusters for qcow2 "
                          "header and refcount table");
