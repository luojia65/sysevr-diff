--- CVE-2016-3710_7.2_CWE-284_3bf1817079bb0d80c0d8a86a7c7dd0bfe90eb82e_vga.c_15_OLD.vul	2020-05-20 08:48:21.436832106 -0400
+++ CVE-2016-3710_7.2_CWE-284_3bf1817079bb0d80c0d8a86a7c7dd0bfe90eb82e_vga.c_15_NEW.vul	2020-05-20 08:48:21.436832106 -0400
@@ -35,6 +35,7 @@
         plane = addr & 3;
         mask = (1 << plane);
         if (s->sr[VGA_SEQ_PLANE_WRITE] & mask) {
+            assert(addr < s->vram_size);
             s->vram_ptr[addr] = val;
 #ifdef DEBUG_VGA_MEM
             printf("vga: chain4: [0x" TARGET_FMT_plx "]\n", addr);
@@ -48,6 +49,9 @@
         mask = (1 << plane);
         if (s->sr[VGA_SEQ_PLANE_WRITE] & mask) {
             addr = ((addr & ~1) << 1) | plane;
+            if (addr >= s->vram_size) {
+                return;
+            }
             s->vram_ptr[addr] = val;
 #ifdef DEBUG_VGA_MEM
             printf("vga: odd/even: [0x" TARGET_FMT_plx "]\n", addr);
@@ -121,6 +125,9 @@
         mask = s->sr[VGA_SEQ_PLANE_WRITE];
         s->plane_updated |= mask; /* only used to detect font change */
         write_mask = mask16[mask];
+        if (addr * sizeof(uint32_t) >= s->vram_size) {
+            return;
+        }
         ((uint32_t *)s->vram_ptr)[addr] =
             (((uint32_t *)s->vram_ptr)[addr] & ~write_mask) |
             (val & write_mask);
