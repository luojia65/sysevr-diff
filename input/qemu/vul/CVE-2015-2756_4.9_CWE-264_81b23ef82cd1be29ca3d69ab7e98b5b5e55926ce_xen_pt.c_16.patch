--- CVE-2015-2756_4.9_CWE-264_81b23ef82cd1be29ca3d69ab7e98b5b5e55926ce_xen_pt.c_16_OLD.vul	2020-05-20 08:33:19.433675553 -0400
+++ CVE-2015-2756_4.9_CWE-264_81b23ef82cd1be29ca3d69ab7e98b5b5e55926ce_xen_pt.c_16_NEW.vul	2020-05-20 08:33:19.441675345 -0400
@@ -3,6 +3,7 @@
     XenPCIPassthroughState *s = DO_UPCAST(XenPCIPassthroughState, dev, d);
     int rc = 0;
     uint8_t machine_irq = 0;
+    uint16_t cmd = 0;
     int pirq = XEN_PT_UNASSIGNED_PIRQ;
 
     /* register real device */
@@ -37,7 +38,7 @@
     s->io_listener = xen_pt_io_listener;
 
     /* Handle real device's MMIO/PIO BARs */
-    xen_pt_register_regions(s);
+    xen_pt_register_regions(s, &cmd);
 
     /* reinitialize each config register to be emulated */
     if (xen_pt_config_init(s)) {
@@ -101,6 +102,11 @@
     }
 
 out:
+    if (cmd) {
+        xen_host_pci_set_word(&s->real_device, PCI_COMMAND,
+                              pci_get_word(d->config + PCI_COMMAND) | cmd);
+    }
+
     memory_listener_register(&s->memory_listener, &s->dev.bus_master_as);
     memory_listener_register(&s->io_listener, &address_space_io);
     XEN_PT_LOG(d,
