--- CVE-2014-0147_0.0_CWE-000_ffa3ab02174f7cb474366bc325bd35264364c9fd_qcow2.c_25_OLD.vul	2020-05-20 08:46:08.853765870 -0400
+++ CVE-2014-0147_0.0_CWE-000_ffa3ab02174f7cb474366bc325bd35264364c9fd_qcow2.c_25_NEW.vul	2020-05-20 08:46:08.853765870 -0400
@@ -29,7 +29,7 @@
      */
     BlockDriverState* bs;
     QCowHeader *header;
-    uint8_t* refcount_table;
+    uint64_t* refcount_table;
     Error *local_err = NULL;
     int ret;
 
@@ -79,9 +79,10 @@
         goto out;
     }
 
-    /* Write an empty refcount table */
-    refcount_table = g_malloc0(cluster_size);
-    ret = bdrv_pwrite(bs, cluster_size, refcount_table, cluster_size);
+    /* Write a refcount table with one refcount block */
+    refcount_table = g_malloc0(2 * cluster_size);
+    refcount_table[0] = cpu_to_be64(2 * cluster_size);
+    ret = bdrv_pwrite(bs, cluster_size, refcount_table, 2 * cluster_size);
     g_free(refcount_table);
 
     if (ret < 0) {
@@ -105,7 +106,7 @@
         goto out;
     }
 
-    ret = qcow2_alloc_clusters(bs, 2 * cluster_size);
+    ret = qcow2_alloc_clusters(bs, 3 * cluster_size);
     if (ret < 0) {
         error_setg_errno(errp, -ret, "Could not allocate clusters for qcow2 "
                          "header and refcount table");
