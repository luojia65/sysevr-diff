--- CVE-2013-4344_6.0_CWE-119_846424350b292f16b732b573273a5c1f195cd7a3_scsi-bus.c_19_OLD.vul	2020-05-20 08:42:04.846845875 -0400
+++ CVE-2013-4344_6.0_CWE-119_846424350b292f16b732b573273a5c1f195cd7a3_scsi-bus.c_19_NEW.vul	2020-05-20 08:42:04.850845727 -0400
@@ -1,6 +1,9 @@
 static bool scsi_target_emulate_inquiry(SCSITargetReq *r)
 {
     assert(r->req.dev->lun != r->req.lun);
+
+    scsi_target_alloc_buf(&r->req, SCSI_INQUIRY_LEN);
+
     if (r->req.cmd.buf[1] & 0x2) {
         /* Command support data - optional, not implemented */
         return false;
@@ -25,7 +28,7 @@
             return false;
         }
         /* done with EVPD */
-        assert(r->len < sizeof(r->buf));
+        assert(r->len < r->buf_len);
         r->len = MIN(r->req.cmd.xfer, r->len);
         return true;
     }
@@ -36,7 +39,7 @@
     }
 
     /* PAGE CODE == 0 */
-    r->len = MIN(r->req.cmd.xfer, 36);
+    r->len = MIN(r->req.cmd.xfer, SCSI_INQUIRY_LEN);
     memset(r->buf, 0, r->len);
     if (r->req.lun != 0) {
         r->buf[0] = TYPE_NO_LUN;
