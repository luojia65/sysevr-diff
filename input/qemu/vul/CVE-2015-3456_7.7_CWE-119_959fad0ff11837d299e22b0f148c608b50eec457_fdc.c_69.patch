--- CVE-2015-3456_7.7_CWE-119_959fad0ff11837d299e22b0f148c608b50eec457_fdc.c_69_OLD.vul	2020-05-20 08:45:34.791033439 -0400
+++ CVE-2015-3456_7.7_CWE-119_959fad0ff11837d299e22b0f148c608b50eec457_fdc.c_69_NEW.vul	2020-05-20 08:45:34.791033439 -0400
@@ -1,10 +1,13 @@
 static void fdctrl_handle_drive_specification_command(FDCtrl *fdctrl, int direction)
 {
     FDrive *cur_drv = get_cur_drv(fdctrl);
+    uint32_t pos;
 
-    if (fdctrl->fifo[fdctrl->data_pos - 1] & 0x80) {
+    pos = fdctrl->data_pos - 1;
+    pos %= FD_SECTOR_LEN;
+    if (fdctrl->fifo[pos] & 0x80) {
         /* Command parameters done */
-        if (fdctrl->fifo[fdctrl->data_pos - 1] & 0x40) {
+        if (fdctrl->fifo[pos] & 0x40) {
             fdctrl->fifo[0] = fdctrl->fifo[1];
             fdctrl->fifo[2] = 0;
             fdctrl->fifo[3] = 0;
