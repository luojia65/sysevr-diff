--- CVE-2014-7840_7.5_CWE-020_0be839a2701369f669532ea5884c15bead1c6e08_arch_init.c_41_OLD.vul	2020-05-20 08:35:01.510454791 -0400
+++ CVE-2014-7840_7.5_CWE-020_0be839a2701369f669532ea5884c15bead1c6e08_arch_init.c_41_NEW.vul	2020-05-20 08:35:01.510454791 -0400
@@ -7,7 +7,7 @@
     uint8_t len;
 
     if (flags & RAM_SAVE_FLAG_CONTINUE) {
-        if (!block) {
+        if (!block || block->length <= offset) {
             error_report("Ack, bad migration stream!");
             return NULL;
         }
@@ -20,8 +20,9 @@
     id[len] = 0;
 
     QTAILQ_FOREACH(block, &ram_list.blocks, next) {
-        if (!strncmp(id, block->idstr, sizeof(id)))
+        if (!strncmp(id, block->idstr, sizeof(id)) && block->length > offset) {
             return memory_region_get_ram_ptr(block->mr) + offset;
+        }
     }
 
     error_report("Can't find block %s!", id);
