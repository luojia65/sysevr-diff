--- CVE-2015-4037_1.9_CWE-017_8b8f1c7e9ddb2e88a144638f6527bf70e32343e3_slirp.c_13_OLD.vul	2020-05-20 08:46:14.981537839 -0400
+++ CVE-2015-4037_1.9_CWE-017_8b8f1c7e9ddb2e88a144638f6527bf70e32343e3_slirp.c_13_NEW.vul	2020-05-20 08:46:14.981537839 -0400
@@ -1,7 +1,6 @@
 static int slirp_smb(SlirpState* s, const char *exported_dir,
                      struct in_addr vserver_addr)
 {
-    static int instance;
     char smb_conf[128];
     char smb_cmdline[128];
     struct passwd *passwd;
@@ -25,10 +24,10 @@
         return -1;
     }
 
-    snprintf(s->smb_dir, sizeof(s->smb_dir), "/tmp/qemu-smb.%ld-%d",
-             (long)getpid(), instance++);
-    if (mkdir(s->smb_dir, 0700) < 0) {
+    snprintf(s->smb_dir, sizeof(s->smb_dir), "/tmp/qemu-smb.XXXXXX");
+    if (!mkdtemp(s->smb_dir)) {
         error_report("could not create samba server dir '%s'", s->smb_dir);
+        s->smb_dir[0] = 0;
         return -1;
     }
     snprintf(smb_conf, sizeof(smb_conf), "%s/%s", s->smb_dir, "smb.conf");
