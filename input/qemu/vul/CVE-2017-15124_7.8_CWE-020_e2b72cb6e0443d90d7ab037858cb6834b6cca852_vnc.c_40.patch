--- CVE-2017-15124_7.8_CWE-020_e2b72cb6e0443d90d7ab037858cb6834b6cca852_vnc.c_40_OLD.vul	2020-05-20 08:49:00.751369106 -0400
+++ CVE-2017-15124_7.8_CWE-020_e2b72cb6e0443d90d7ab037858cb6834b6cca852_vnc.c_40_NEW.vul	2020-05-20 08:49:00.751369106 -0400
@@ -3,11 +3,13 @@
     VncState *vs = opaque;
 
     vnc_lock_output(vs);
-    vnc_write_u8(vs, VNC_MSG_SERVER_QEMU);
-    vnc_write_u8(vs, VNC_MSG_SERVER_QEMU_AUDIO);
-    vnc_write_u16(vs, VNC_MSG_SERVER_QEMU_AUDIO_DATA);
-    vnc_write_u32(vs, size);
-    vnc_write(vs, buf, size);
+    if (vs->output.offset < vs->throttle_output_offset) {
+        vnc_write_u8(vs, VNC_MSG_SERVER_QEMU);
+        vnc_write_u8(vs, VNC_MSG_SERVER_QEMU_AUDIO);
+        vnc_write_u16(vs, VNC_MSG_SERVER_QEMU_AUDIO_DATA);
+        vnc_write_u32(vs, size);
+        vnc_write(vs, buf, size);
+    }
     vnc_unlock_output(vs);
     vnc_flush(vs);
 }
