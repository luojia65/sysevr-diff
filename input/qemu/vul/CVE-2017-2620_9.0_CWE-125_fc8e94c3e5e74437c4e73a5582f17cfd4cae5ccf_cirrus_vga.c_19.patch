--- CVE-2017-2620_9.0_CWE-125_fc8e94c3e5e74437c4e73a5582f17cfd4cae5ccf_cirrus_vga.c_19_OLD.vul	2020-05-20 08:50:52.899195764 -0400
+++ CVE-2017-2620_9.0_CWE-125_fc8e94c3e5e74437c4e73a5582f17cfd4cae5ccf_cirrus_vga.c_19_NEW.vul	2020-05-20 08:50:52.899195764 -0400
@@ -2,6 +2,10 @@
 {
     int w;
 
+    if (blit_is_unsafe(s, true)) {
+        return 0;
+    }
+
     s->cirrus_blt_mode &= ~CIRRUS_BLTMODE_MEMSYSSRC;
     s->cirrus_srcptr = &s->cirrus_bltbuf[0];
     s->cirrus_srcptr_end = &s->cirrus_bltbuf[0];
@@ -27,6 +31,10 @@
 	}
         s->cirrus_srccounter = s->cirrus_blt_srcpitch * s->cirrus_blt_height;
     }
+
+    /* the blit_is_unsafe call above should catch this */
+    assert(s->cirrus_blt_srcpitch <= CIRRUS_BLTBUFSIZE);
+
     s->cirrus_srcptr = s->cirrus_bltbuf;
     s->cirrus_srcptr_end = s->cirrus_bltbuf + s->cirrus_blt_srcpitch;
     cirrus_update_memory_access(s);
