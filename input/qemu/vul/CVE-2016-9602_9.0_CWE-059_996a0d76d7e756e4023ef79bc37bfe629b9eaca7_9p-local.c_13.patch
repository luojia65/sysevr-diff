--- CVE-2016-9602_9.0_CWE-059_996a0d76d7e756e4023ef79bc37bfe629b9eaca7_9p-local.c_13_OLD.vul	2020-05-20 08:37:30.161053935 -0400
+++ CVE-2016-9602_9.0_CWE-059_996a0d76d7e756e4023ef79bc37bfe629b9eaca7_9p-local.c_13_NEW.vul	2020-05-20 08:37:30.161053935 -0400
@@ -1,13 +1,15 @@
 static int local_opendir(FsContext *ctx,
                          V9fsPath *fs_path, V9fsFidOpenState *fs)
 {
-    char *buffer;
-    char *path = fs_path->data;
+    int dirfd;
     DIR *stream;
 
-    buffer = rpath(ctx, path);
-    stream = opendir(buffer);
-    g_free(buffer);
+    dirfd = local_opendir_nofollow(ctx, fs_path->data);
+    if (dirfd == -1) {
+        return -1;
+    }
+
+    stream = fdopendir(dirfd);
     if (!stream) {
         return -1;
     }
