--- CVE-2016-9602_9.0_CWE-059_acf22d2264a131ad2695b5a18746dabf0cc8b843_9p-local.c_13_OLD.vul	2020-05-20 08:41:48.739445225 -0400
+++ CVE-2016-9602_9.0_CWE-059_acf22d2264a131ad2695b5a18746dabf0cc8b843_9p-local.c_13_NEW.vul	2020-05-20 08:41:48.739445225 -0400
@@ -1,13 +1,15 @@
 static int local_opendir(FsContext *ctx,
                          V9fsPath *fs_path, V9fsFidOpenState *fs)
 {
-    char *buffer;
-    char *path = fs_path->data;
+    int dirfd;
     DIR *stream;
 
-    buffer = rpath(ctx, path);
-    stream = opendir(buffer);
-    g_free(buffer);
+    dirfd = local_opendir_nofollow(ctx, fs_path->data);
+    if (dirfd == -1) {
+        return -1;
+    }
+
+    stream = fdopendir(dirfd);
     if (!stream) {
         return -1;
     }
