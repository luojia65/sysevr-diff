--- CVE-2008-1945_4.9_CWE-200_2ecea9b8de5cd74df314541b87f712ae77f862ec_monitor.c_28_OLD.vul	2020-05-20 08:46:21.797284206 -0400
+++ CVE-2008-1945_4.9_CWE-200_2ecea9b8de5cd74df314541b87f712ae77f862ec_monitor.c_28_NEW.vul	2020-05-20 08:46:21.797284206 -0400
@@ -1,14 +1,22 @@
-static void do_change_block(const char *device, const char *filename)
+static void do_change_block(const char *device, const char *filename, const char *fmt)
 {
     BlockDriverState *bs;
+    BlockDriver *drv = NULL;
 
     bs = bdrv_find(device);
     if (!bs) {
         term_printf("device not found\n");
         return;
     }
+    if (fmt) {
+        drv = bdrv_find_format(fmt);
+        if (!drv) {
+            term_printf("invalid format %s\n", fmt);
+            return;
+        }
+    }
     if (eject_device(bs, 0) < 0)
         return;
-    bdrv_open(bs, filename, 0);
+    bdrv_open2(bs, filename, 0, drv);
     qemu_key_check(bs, filename);
 }
