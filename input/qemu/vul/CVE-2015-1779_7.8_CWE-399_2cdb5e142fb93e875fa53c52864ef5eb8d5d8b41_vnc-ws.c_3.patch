--- CVE-2015-1779_7.8_CWE-399_2cdb5e142fb93e875fa53c52864ef5eb8d5d8b41_vnc-ws.c_3_OLD.vul	2020-05-20 08:31:44.883598784 -0400
+++ CVE-2015-1779_7.8_CWE-399_2cdb5e142fb93e875fa53c52864ef5eb8d5d8b41_vnc-ws.c_3_NEW.vul	2020-05-20 08:31:44.883598784 -0400
@@ -3,8 +3,11 @@
     VncState *vs = opaque;
     uint8_t *handshake_end;
     long ret;
-    buffer_reserve(&vs->ws_input, 4096);
-    ret = vnc_client_read_buf(vs, buffer_end(&vs->ws_input), 4096);
+    /* Typical HTTP headers from novnc are 512 bytes, so limiting
+     * total header size to 4096 is easily enough. */
+    size_t want = 4096 - vs->ws_input.offset;
+    buffer_reserve(&vs->ws_input, want);
+    ret = vnc_client_read_buf(vs, buffer_end(&vs->ws_input), want);
 
     if (!ret) {
         if (vs->csock == -1) {
@@ -21,5 +24,8 @@
         vncws_process_handshake(vs, vs->ws_input.buffer, vs->ws_input.offset);
         buffer_advance(&vs->ws_input, handshake_end - vs->ws_input.buffer +
                 strlen(WS_HANDSHAKE_END));
+    } else if (vs->ws_input.offset >= 4096) {
+        VNC_DEBUG("End of headers not found in first 4096 bytes\n");
+        vnc_client_error(vs);
     }
 }
