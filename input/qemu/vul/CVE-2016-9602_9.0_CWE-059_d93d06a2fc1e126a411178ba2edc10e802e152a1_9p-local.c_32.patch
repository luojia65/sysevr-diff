--- CVE-2016-9602_9.0_CWE-059_d93d06a2fc1e126a411178ba2edc10e802e152a1_9p-local.c_32_OLD.vul	2020-05-20 08:39:00.785692132 -0400
+++ CVE-2016-9602_9.0_CWE-059_d93d06a2fc1e126a411178ba2edc10e802e152a1_9p-local.c_32_NEW.vul	2020-05-20 08:39:00.785692132 -0400
@@ -2,28 +2,19 @@
                         const char *newpath)
 {
     int err;
-    char *buffer, *buffer1;
+    char *oname = g_path_get_basename(oldpath);
+    char *nname = g_path_get_basename(newpath);
+    V9fsPath olddir, newdir;
 
-    if (ctx->export_flags & V9FS_SM_MAPPED_FILE) {
-        err = local_create_mapped_attr_dir(ctx, newpath);
-        if (err < 0) {
-            return err;
-        }
-        /* rename the .virtfs_metadata files */
-        buffer = local_mapped_attr_path(ctx, oldpath);
-        buffer1 = local_mapped_attr_path(ctx, newpath);
-        err = rename(buffer, buffer1);
-        g_free(buffer);
-        g_free(buffer1);
-        if (err < 0 && errno != ENOENT) {
-            return err;
-        }
-    }
+    v9fs_path_init_dirname(&olddir, oldpath);
+    v9fs_path_init_dirname(&newdir, newpath);
+
+    err = local_renameat(ctx, &olddir, oname, &newdir, nname);
+
+    v9fs_path_free(&newdir);
+    v9fs_path_free(&olddir);
+    g_free(nname);
+    g_free(oname);
 
-    buffer = rpath(ctx, oldpath);
-    buffer1 = rpath(ctx, newpath);
-    err = rename(buffer, buffer1);
-    g_free(buffer);
-    g_free(buffer1);
     return err;
 }
