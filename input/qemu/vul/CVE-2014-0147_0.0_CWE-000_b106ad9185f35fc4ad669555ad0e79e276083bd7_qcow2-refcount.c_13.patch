--- CVE-2014-0147_0.0_CWE-000_b106ad9185f35fc4ad669555ad0e79e276083bd7_qcow2-refcount.c_13_OLD.vul	2020-05-20 08:35:47.660812192 -0400
+++ CVE-2014-0147_0.0_CWE-000_b106ad9185f35fc4ad669555ad0e79e276083bd7_qcow2-refcount.c_13_NEW.vul	2020-05-20 08:35:47.660812192 -0400
@@ -4,12 +4,15 @@
     int ret;
 
     BLKDBG_EVENT(bs->file, BLKDBG_CLUSTER_ALLOC);
-    offset = alloc_clusters_noref(bs, size);
-    if (offset < 0) {
-        return offset;
-    }
+    do {
+        offset = alloc_clusters_noref(bs, size);
+        if (offset < 0) {
+            return offset;
+        }
+
+        ret = update_refcount(bs, offset, size, 1, QCOW2_DISCARD_NEVER);
+    } while (ret == -EAGAIN);
 
-    ret = update_refcount(bs, offset, size, 1, QCOW2_DISCARD_NEVER);
     if (ret < 0) {
         return ret;
     }
