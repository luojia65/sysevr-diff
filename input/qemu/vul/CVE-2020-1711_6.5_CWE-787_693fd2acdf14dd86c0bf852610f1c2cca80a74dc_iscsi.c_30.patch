--- CVE-2020-1711_6.5_CWE-787_693fd2acdf14dd86c0bf852610f1c2cca80a74dc_iscsi.c_30_OLD.vul	2020-05-20 08:45:43.294716991 -0400
+++ CVE-2020-1711_6.5_CWE-787_693fd2acdf14dd86c0bf852610f1c2cca80a74dc_iscsi.c_30_NEW.vul	2020-05-20 08:45:43.294716991 -0400
@@ -8,7 +8,7 @@
     struct scsi_get_lba_status *lbas = NULL;
     struct scsi_lba_status_descriptor *lbasd = NULL;
     struct IscsiTask iTask;
-    uint64_t lba;
+    uint64_t lba, max_bytes;
     int ret;
 
     iscsi_co_init_iscsitask(iscsilun, &iTask);
@@ -28,6 +28,7 @@
     }
 
     lba = offset / iscsilun->block_size;
+    max_bytes = (iscsilun->num_blocks - lba) * iscsilun->block_size;
 
     qemu_mutex_lock(&iscsilun->mutex);
 retry:
@@ -71,7 +72,7 @@
         goto out_unlock;
     }
 
-    *pnum = (int64_t) lbasd->num_blocks * iscsilun->block_size;
+    *pnum = MIN((int64_t) lbasd->num_blocks * iscsilun->block_size, max_bytes);
 
     if (lbasd->provisioning == SCSI_PROVISIONING_TYPE_DEALLOCATED ||
         lbasd->provisioning == SCSI_PROVISIONING_TYPE_ANCHORED) {
