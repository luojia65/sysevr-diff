--- CVE-2018-19489_2.1_CWE-362_d086829e5ba00d75637cd6ab51c4f291f62db941_9p.c_73_OLD.vul	2020-05-20 08:50:57.587021321 -0400
+++ CVE-2018-19489_2.1_CWE-362_d086829e5ba00d75637cd6ab51c4f291f62db941_9p.c_73_NEW.vul	2020-05-20 08:50:57.587021321 -0400
@@ -8,6 +8,7 @@
     struct stat stbuf;
     V9fsFidState *fidp;
     V9fsPDU *pdu = opaque;
+    V9fsState *s = pdu->s;
 
     v9fs_stat_init(&v9stat);
     err = pdu_unmarshal(pdu, offset, "dwS", &fid, &unused, &v9stat);
@@ -73,7 +74,9 @@
         }
     }
     if (v9stat.name.size != 0) {
+        v9fs_path_write_lock(s);
         err = v9fs_complete_rename(pdu, fidp, -1, &v9stat.name);
+        v9fs_path_unlock(s);
         if (err < 0) {
             goto out;
         }
