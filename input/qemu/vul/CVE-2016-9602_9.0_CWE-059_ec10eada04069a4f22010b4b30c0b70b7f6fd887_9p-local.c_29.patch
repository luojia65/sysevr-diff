--- CVE-2016-9602_9.0_CWE-059_ec10eada04069a4f22010b4b30c0b70b7f6fd887_9p-local.c_29_OLD.vul	2020-05-20 08:43:50.610910242 -0400
+++ CVE-2016-9602_9.0_CWE-059_ec10eada04069a4f22010b4b30c0b70b7f6fd887_9p-local.c_29_NEW.vul	2020-05-20 08:43:50.610910242 -0400
@@ -1,11 +1,12 @@
 static int local_truncate(FsContext *ctx, V9fsPath *fs_path, off_t size)
 {
-    char *buffer;
-    int ret;
-    char *path = fs_path->data;
+    int fd, ret;
 
-    buffer = rpath(ctx, path);
-    ret = truncate(buffer, size);
-    g_free(buffer);
+    fd = local_open_nofollow(ctx, fs_path->data, O_WRONLY, 0);
+    if (fd == -1) {
+        return -1;
+    }
+    ret = ftruncate(fd, size);
+    close_preserve_errno(fd);
     return ret;
 }
