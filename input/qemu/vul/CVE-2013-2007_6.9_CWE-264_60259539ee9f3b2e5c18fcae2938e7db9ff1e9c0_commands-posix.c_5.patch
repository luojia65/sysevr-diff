--- CVE-2013-2007_6.9_CWE-264_60259539ee9f3b2e5c18fcae2938e7db9ff1e9c0_commands-posix.c_5_OLD.vul	2020-05-20 08:47:34.714570768 -0400
+++ CVE-2013-2007_6.9_CWE-264_60259539ee9f3b2e5c18fcae2938e7db9ff1e9c0_commands-posix.c_5_NEW.vul	2020-05-20 08:47:34.718570619 -0400
@@ -1,6 +1,7 @@
 int64_t qmp_guest_file_open(const char *path, bool has_mode, const char *mode, Error **err)
 {
     FILE *fh;
+    Error *local_err = NULL;
     int fd;
     int64_t ret = -1, handle;
 
@@ -8,10 +9,9 @@
         mode = "r";
     }
     slog("guest-file-open called, filepath: %s, mode: %s", path, mode);
-    fh = fopen(path, mode);
-    if (!fh) {
-        error_setg_errno(err, errno, "failed to open file '%s' (mode: '%s')",
-                         path, mode);
+    fh = safe_open_or_create(path, mode, &local_err);
+    if (local_err != NULL) {
+        error_propagate(err, local_err);
         return -1;
     }
 
