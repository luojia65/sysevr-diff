--- CVE-2017-13673_4.0_CWE-617_d6f7f3b0cf4b6c5e7cdff9dfa6d20545e1051375_vga.c_32_OLD.vul	2020-05-20 08:32:25.847219178 -0400
+++ CVE-2017-13673_4.0_CWE-617_d6f7f3b0cf4b6c5e7cdff9dfa6d20545e1051375_vga.c_32_NEW.vul	2020-05-20 08:32:25.847219178 -0400
@@ -166,9 +166,15 @@
     y1 = 0;
 
     if (!full_update) {
+        ram_addr_t region_start = addr1;
+        ram_addr_t region_end = addr1 + line_offset * height;
         vga_sync_dirty_bitmap(s);
-        snap = memory_region_snapshot_and_clear_dirty(&s->vram, addr1,
-                                                      line_offset * height,
+        if (s->line_compare < height) {
+            /* split screen mode */
+            region_start = 0;
+        }
+        snap = memory_region_snapshot_and_clear_dirty(&s->vram, region_start,
+                                                      region_end - region_start,
                                                       DIRTY_MEMORY_VGA);
     }
 
