--- CVE-2008-2004_4.9_CWE-200_79368c81bf8cf93864d7afc88b81b05d8f0a2c90_raw.c_3_OLD.vul	2020-05-20 08:37:05.153977794 -0400
+++ CVE-2008-2004_4.9_CWE-200_79368c81bf8cf93864d7afc88b81b05d8f0a2c90_raw.c_3_NEW.vul	2020-05-20 08:37:05.153977794 -0400
@@ -1,5 +1,21 @@
 static int raw_write(BlockDriverState *bs, int64_t sector_num,
                      const uint8_t *buf, int nb_sectors)
 {
+    if (check_write_unsafe(bs, sector_num, buf, nb_sectors)) {
+        int ret;
+
+        ret = raw_write_scrubbed_bootsect(bs, buf);
+        if (ret < 0) {
+            return ret;
+        }
+
+        ret = bdrv_write(bs->file, 1, buf + 512, nb_sectors - 1);
+        if (ret < 0) {
+            return ret;
+        }
+
+        return ret + 512;
+    }
+
     return bdrv_write(bs->file, sector_num, buf, nb_sectors);
 }
