--- CVE-2018-18954_2.1_CWE-125_8d2527617218cc65dfd978432b5e2159eb87ae5a_pnv_lpc.c_4_OLD.vul	2020-05-20 08:34:36.867303170 -0400
+++ CVE-2018-18954_2.1_CWE-125_8d2527617218cc65dfd978432b5e2159eb87ae5a_pnv_lpc.c_4_NEW.vul	2020-05-20 08:34:36.867303170 -0400
@@ -3,9 +3,15 @@
     /* XXX Check for magic bits at the top, addr size etc... */
     unsigned int sz = (cmd & ECCB_CTL_SZ_MASK) >> ECCB_CTL_SZ_LSH;
     uint32_t opb_addr = cmd & ECCB_CTL_ADDR_MASK;
-    uint8_t data[4];
+    uint8_t data[8];
     bool success;
 
+    if (sz > sizeof(data)) {
+        qemu_log_mask(LOG_GUEST_ERROR,
+            "ECCB: invalid operation at @0x%08x size %d\n", opb_addr, sz);
+        return;
+    }
+
     if (cmd & ECCB_CTL_READ) {
         success = opb_read(lpc, opb_addr, data, sz);
         if (success) {
