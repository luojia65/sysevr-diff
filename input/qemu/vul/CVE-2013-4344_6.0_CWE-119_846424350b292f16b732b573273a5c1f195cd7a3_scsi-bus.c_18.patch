--- CVE-2013-4344_6.0_CWE-119_846424350b292f16b732b573273a5c1f195cd7a3_scsi-bus.c_18_OLD.vul	2020-05-20 08:42:04.834846321 -0400
+++ CVE-2013-4344_6.0_CWE-119_846424350b292f16b732b573273a5c1f195cd7a3_scsi-bus.c_18_NEW.vul	2020-05-20 08:42:04.834846321 -0400
@@ -29,14 +29,12 @@
     if (!found_lun0) {
         n += 8;
     }
-    len = MIN(n + 8, r->req.cmd.xfer & ~7);
-    if (len > sizeof(r->buf)) {
-        /* TODO: > 256 LUNs? */
-        return false;
-    }
 
+    scsi_target_alloc_buf(&r->req, n + 8);
+
+    len = MIN(n + 8, r->req.cmd.xfer & ~7);
     memset(r->buf, 0, len);
-    stl_be_p(&r->buf, n);
+    stl_be_p(&r->buf[0], n);
     i = found_lun0 ? 8 : 16;
     QTAILQ_FOREACH(kid, &r->req.bus->qbus.children, sibling) {
         DeviceState *qdev = kid->child;
