--- CVE-2017-5898_2.1_CWE-190_31fb4444a485a348f8e2699d7c3dd15e1819ad2c_dev-smartcard-reader.c_36_OLD.vul	2020-05-20 08:32:52.330445375 -0400
+++ CVE-2017-5898_2.1_CWE-190_31fb4444a485a348f8e2699d7c3dd15e1819ad2c_dev-smartcard-reader.c_36_NEW.vul	2020-05-20 08:32:52.330445375 -0400
@@ -13,12 +13,19 @@
     }
 
     ccid_header = (CCID_Header *)s->bulk_out_data;
-    if (p->iov.size == CCID_MAX_PACKET_SIZE) {
+    if ((s->bulk_out_pos - 10 < ccid_header->dwLength) &&
+        (p->iov.size == CCID_MAX_PACKET_SIZE)) {
         DPRINTF(s, D_VERBOSE,
-            "usb-ccid: bulk_in: expecting more packets (%zd/%d)\n",
-            p->iov.size, ccid_header->dwLength);
+                "usb-ccid: bulk_in: expecting more packets (%d/%d)\n",
+                s->bulk_out_pos - 10, ccid_header->dwLength);
         return;
     }
+    if (s->bulk_out_pos - 10 != ccid_header->dwLength) {
+        DPRINTF(s, 1,
+                "usb-ccid: bulk_in: message size mismatch (got %d, expected %d)\n",
+                s->bulk_out_pos - 10, ccid_header->dwLength);
+        goto err;
+    }
 
     DPRINTF(s, D_MORE_INFO, "%s %x %s\n", __func__,
             ccid_header->bMessageType,
