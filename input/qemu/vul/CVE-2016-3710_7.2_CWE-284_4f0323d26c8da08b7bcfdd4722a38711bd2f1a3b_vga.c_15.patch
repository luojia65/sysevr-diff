--- CVE-2016-3710_7.2_CWE-284_4f0323d26c8da08b7bcfdd4722a38711bd2f1a3b_vga.c_15_OLD.vul	2020-05-20 08:38:15.071389764 -0400
+++ CVE-2016-3710_7.2_CWE-284_4f0323d26c8da08b7bcfdd4722a38711bd2f1a3b_vga.c_15_NEW.vul	2020-05-20 08:38:15.071389764 -0400
@@ -35,6 +35,7 @@
         plane = addr & 3;
         mask = (1 << plane);
         if (s->sr[VGA_SEQ_PLANE_WRITE] & mask) {
+            assert(addr < s->vram_size);
             s->vram_ptr[addr] = val;
 #ifdef DEBUG_VGA_MEM
             printf("vga: chain4: [0x" TARGET_FMT_plx "]\n", addr);
@@ -48,6 +49,9 @@
         mask = (1 << plane);
         if (s->sr[VGA_SEQ_PLANE_WRITE] & mask) {
             addr = ((addr & ~1) << 1) | plane;
+            if (addr >= s->vram_size) {
+                return;
+            }
             s->vram_ptr[addr] = val;
 #ifdef DEBUG_VGA_MEM
             printf("vga: odd/even: [0x" TARGET_FMT_plx "]\n", addr);
@@ -121,6 +125,9 @@
         mask = s->sr[VGA_SEQ_PLANE_WRITE];
         s->plane_updated |= mask; /* only used to detect font change */
         write_mask = mask16[mask];
+        if (addr * sizeof(uint32_t) >= s->vram_size) {
+            return;
+        }
         ((uint32_t *)s->vram_ptr)[addr] =
             (((uint32_t *)s->vram_ptr)[addr] & ~write_mask) |
             (val & write_mask);
