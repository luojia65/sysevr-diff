--- CVE-2016-4441_2.1_CWE-119_6c1fef6b59563cc415f21e03f81539ed4b33ad90_esp.c_5_OLD.vul	2020-05-20 08:49:34.890098704 -0400
+++ CVE-2016-4441_2.1_CWE-119_6c1fef6b59563cc415f21e03f81539ed4b33ad90_esp.c_5_NEW.vul	2020-05-20 08:49:34.890098704 -0400
@@ -1,4 +1,4 @@
-static uint32_t get_cmd(ESPState *s, uint8_t *buf)
+static uint32_t get_cmd(ESPState *s, uint8_t *buf, uint8_t buflen)
 {
     uint32_t dmalen;
     int target;
@@ -8,6 +8,9 @@
         dmalen = s->rregs[ESP_TCLO];
         dmalen |= s->rregs[ESP_TCMID] << 8;
         dmalen |= s->rregs[ESP_TCHI] << 16;
+        if (dmalen > buflen) {
+            return 0;
+        }
         s->dma_memory_read(s->dma_opaque, buf, dmalen);
     } else {
         dmalen = s->ti_size;
