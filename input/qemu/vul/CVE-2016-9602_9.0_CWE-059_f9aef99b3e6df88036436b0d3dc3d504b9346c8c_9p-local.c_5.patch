--- CVE-2016-9602_9.0_CWE-059_f9aef99b3e6df88036436b0d3dc3d504b9346c8c_9p-local.c_5_OLD.vul	2020-05-20 08:49:03.639261635 -0400
+++ CVE-2016-9602_9.0_CWE-059_f9aef99b3e6df88036436b0d3dc3d504b9346c8c_9p-local.c_5_NEW.vul	2020-05-20 08:49:03.639261635 -0400
@@ -1,13 +1,18 @@
-static void local_mapped_file_attr(FsContext *ctx, const char *path,
+static void local_mapped_file_attr(int dirfd, const char *name,
                                    struct stat *stbuf)
 {
     FILE *fp;
     char buf[ATTR_MAX];
-    char *attr_path;
+    int map_dirfd;
 
-    attr_path = local_mapped_attr_path(ctx, path);
-    fp = local_fopen(attr_path, "r");
-    g_free(attr_path);
+    map_dirfd = openat(dirfd, VIRTFS_META_DIR,
+                       O_RDONLY | O_DIRECTORY | O_NOFOLLOW);
+    if (map_dirfd == -1) {
+        return;
+    }
+
+    fp = local_fopenat(map_dirfd, name, "r");
+    close_preserve_errno(map_dirfd);
     if (!fp) {
         return;
     }
