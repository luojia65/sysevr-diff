--- CVE-2013-4151_7.5_CWE-094_48935f029f5ae7f6bd6f01b2c942a7f2f1a7bc9a_virtio.c_58_OLD.vul	2020-05-20 08:49:13.402898312 -0400
+++ CVE-2013-4151_7.5_CWE-094_48935f029f5ae7f6bd6f01b2c942a7f2f1a7bc9a_virtio.c_58_NEW.vul	2020-05-20 08:49:13.402898312 -0400
@@ -1,6 +1,7 @@
 int virtio_load(VirtIODevice *vdev, QEMUFile *f)
 {
-    int num, i, ret;
+    int i, ret;
+    uint32_t num;
     uint32_t features;
     uint32_t supported_features;
     BusState *qbus = qdev_get_parent_bus(DEVICE(vdev));
@@ -31,6 +32,11 @@
 
     num = qemu_get_be32(f);
 
+    if (num > VIRTIO_PCI_QUEUE_MAX) {
+        error_report("Invalid number of PCI queues: 0x%x", num);
+        return -1;
+    }
+
     for (i = 0; i < num; i++) {
         vdev->vq[i].vring.num = qemu_get_be32(f);
         if (k->has_variable_vring_alignment) {
