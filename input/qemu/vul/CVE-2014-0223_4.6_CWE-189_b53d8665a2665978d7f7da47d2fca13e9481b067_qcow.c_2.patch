--- CVE-2014-0223_4.6_CWE-189_b53d8665a2665978d7f7da47d2fca13e9481b067_qcow.c_2_OLD.vul	2020-05-20 08:36:31.887201519 -0400
+++ CVE-2014-0223_4.6_CWE-189_b53d8665a2665978d7f7da47d2fca13e9481b067_qcow.c_2_NEW.vul	2020-05-20 08:36:31.887201519 -0400
@@ -68,7 +68,19 @@
 
     /* read the level 1 table */
     shift = s->cluster_bits + s->l2_bits;
-    s->l1_size = (header.size + (1LL << shift) - 1) >> shift;
+    if (header.size > UINT64_MAX - (1LL << shift)) {
+        error_setg(errp, "Image too large");
+        ret = -EINVAL;
+        goto fail;
+    } else {
+        uint64_t l1_size = (header.size + (1LL << shift) - 1) >> shift;
+        if (l1_size > INT_MAX / sizeof(uint64_t)) {
+            error_setg(errp, "Image too large");
+            ret = -EINVAL;
+            goto fail;
+        }
+        s->l1_size = l1_size;
+    }
 
     s->l1_table_offset = header.l1_table_offset;
     s->l1_table = g_malloc(s->l1_size * sizeof(uint64_t));
