--- CVE-2017-15124_7.8_CWE-020_f9e53c77ea3bfe92ddc8c755935e7521dd3ed08e_vnc.c_37_OLD.vul	2020-05-20 08:44:03.438432903 -0400
+++ CVE-2017-15124_7.8_CWE-020_f9e53c77ea3bfe92ddc8c755935e7521dd3ed08e_vnc.c_37_NEW.vul	2020-05-20 08:44:03.438432903 -0400
@@ -5,14 +5,28 @@
         break;
     case VNC_STATE_UPDATE_INCREMENTAL:
         /* Only allow incremental updates if the pending send queue
-         * is less than the permitted threshold
+         * is less than the permitted threshold, and the job worker
+         * is completely idle.
          */
-        if (vs->output.offset < vs->throttle_output_offset) {
+        if (vs->output.offset < vs->throttle_output_offset &&
+            vs->job_update == VNC_STATE_UPDATE_NONE) {
             return true;
         }
         break;
     case VNC_STATE_UPDATE_FORCE:
-        return true;
+        /* Only allow forced updates if the pending send queue
+         * does not contain a previous forced update, and the
+         * job worker is completely idle.
+         *
+         * Note this means we'll queue a forced update, even if
+         * the output buffer size is otherwise over the throttle
+         * output limit.
+         */
+        if (vs->force_update_offset == 0 &&
+            vs->job_update == VNC_STATE_UPDATE_NONE) {
+            return true;
+        }
+        break;
     }
     return false;
 }
