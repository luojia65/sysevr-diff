--- CVE-2016-9602_9.0_CWE-059_a33eda0dd99e00faa3bacae43d19490bb9500e07_9p-local.c_32_OLD.vul	2020-05-20 08:35:38.185153543 -0400
+++ CVE-2016-9602_9.0_CWE-059_a33eda0dd99e00faa3bacae43d19490bb9500e07_9p-local.c_32_NEW.vul	2020-05-20 08:35:38.185153543 -0400
@@ -1,12 +1,19 @@
 static int local_utimensat(FsContext *s, V9fsPath *fs_path,
                            const struct timespec *buf)
 {
-    char *buffer;
-    int ret;
-    char *path = fs_path->data;
+    char *dirpath = g_path_get_dirname(fs_path->data);
+    char *name = g_path_get_basename(fs_path->data);
+    int dirfd, ret = -1;
 
-    buffer = rpath(s, path);
-    ret = qemu_utimens(buffer, buf);
-    g_free(buffer);
+    dirfd = local_opendir_nofollow(s, dirpath);
+    if (dirfd == -1) {
+        goto out;
+    }
+
+    ret = utimensat(dirfd, name, buf, AT_SYMLINK_NOFOLLOW);
+    close_preserve_errno(dirfd);
+out:
+    g_free(dirpath);
+    g_free(name);
     return ret;
 }
