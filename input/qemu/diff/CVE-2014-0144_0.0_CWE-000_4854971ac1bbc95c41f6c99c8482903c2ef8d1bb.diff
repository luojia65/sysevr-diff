commit 4854971ac1bbc95c41f6c99c8482903c2ef8d1bb
Author:     Fam Zheng <famz@redhat.com>
AuthorDate: Wed Mar 26 13:05:40 2014 +0100
Commit:     Michael Roth <mdroth@linux.vnet.ibm.com>
CommitDate: Thu Jul 3 16:18:11 2014 -0500

    curl: check data size before memcpy to local buffer. (CVE-2014-0144)
    
    curl_read_cb is callback function for libcurl when data arrives. The
    data size passed in here is not guaranteed to be within the range of
    request we submitted, so we may overflow the guest IO buffer. Check the
    real size we have before memcpy to buffer to avoid overflow.
    
    Signed-off-by: Fam Zheng <famz@redhat.com>
    Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>
    Reviewed-by: Max Reitz <mreitz@redhat.com>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
    (cherry picked from commit 6d4b9e55fc625514a38d27cff4b9933f617fa7dc)
    Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

diff --git a/block/curl.c b/block/curl.c
index 1c04dccb82..47cf70a159 100644
--- a/block/curl.c
+++ b/block/curl.c
@@ -157,6 +157,11 @@ static size_t curl_read_cb(void *ptr, size_t size, size_t nmemb, void *opaque)
     if (!s || !s->orig_buf)
         goto read_end;
 
+    if (s->buf_off >= s->buf_len) {
+        /* buffer full, read nothing */
+        return 0;
+    }
+    realsize = MIN(realsize, s->buf_len - s->buf_off);
     memcpy(s->orig_buf + s->buf_off, ptr, realsize);
     s->buf_off += realsize;
 
