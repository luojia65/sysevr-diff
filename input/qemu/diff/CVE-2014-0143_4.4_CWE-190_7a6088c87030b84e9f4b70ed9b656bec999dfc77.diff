commit 7a6088c87030b84e9f4b70ed9b656bec999dfc77
Author:     Kevin Wolf <kwolf@redhat.com>
AuthorDate: Wed Mar 26 13:05:49 2014 +0100
Commit:     Michael Roth <mdroth@linux.vnet.ibm.com>
CommitDate: Thu Jul 3 16:18:12 2014 -0500

    qcow2: Avoid integer overflow in get_refcount (CVE-2014-0143)
    
    This ensures that the checks catch all invalid cluster indexes
    instead of returning the refcount of a wrong cluster.
    
    Signed-off-by: Kevin Wolf <kwolf@redhat.com>
    Reviewed-by: Max Reitz <mreitz@redhat.com>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
    (cherry picked from commit db8a31d11d6a60f48d6817530640d75aa72a9a2f)
    Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

diff --git a/block/qcow2-refcount.c b/block/qcow2-refcount.c
index 22dfb2d2b2..57c1fbad96 100644
--- a/block/qcow2-refcount.c
+++ b/block/qcow2-refcount.c
@@ -89,7 +89,7 @@ static int load_refcount_block(BlockDriverState *bs,
 static int get_refcount(BlockDriverState *bs, int64_t cluster_index)
 {
     BDRVQcowState *s = bs->opaque;
-    int refcount_table_index, block_index;
+    uint64_t refcount_table_index, block_index;
     int64_t refcount_block_offset;
     int ret;
     uint16_t *refcount_block;
