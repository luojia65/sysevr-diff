commit b7a197c39e4b2099f25d2137e8d73c53c37b92c6
Author:     Stefan Hajnoczi <stefanha@redhat.com>
AuthorDate: Wed Jul 15 17:34:40 2015 +0100
Commit:     Michael Roth <mdroth@linux.vnet.ibm.com>
CommitDate: Tue Aug 4 12:33:48 2015 -0500

    rtl8139: check IP Total Length field (CVE-2015-5165)
    
    The IP Total Length field includes the IP header and data.  Make sure it
    is valid and does not exceed the Ethernet payload size.
    
    Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
    Reviewed-by: Jason Wang <jasowang@redhat.com>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
    (cherry picked from commit c6296ea88df040054ccd781f3945fe103f8c7c17)
    Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

diff --git a/hw/net/rtl8139.c b/hw/net/rtl8139.c
index 2d978660be..c88bf9b311 100644
--- a/hw/net/rtl8139.c
+++ b/hw/net/rtl8139.c
@@ -2191,7 +2191,12 @@ static int rtl8139_cplus_transmit_one(RTL8139State *s)
             }
 
             ip_protocol = ip->ip_p;
-            ip_data_len = be16_to_cpu(ip->ip_len) - hlen;
+
+            ip_data_len = be16_to_cpu(ip->ip_len);
+            if (ip_data_len < hlen || ip_data_len > eth_payload_len) {
+                goto skip_offload;
+            }
+            ip_data_len -= hlen;
 
             if (txdw0 & CP_TX_IPCS)
             {
