commit 3a56af1fbc17ff453f6e90fb08ce0c0e6fd0b61b
Author:     P J P <pjp@fedoraproject.org>
AuthorDate: Fri Sep 4 17:21:06 2015 +0100
Commit:     Michael Roth <mdroth@linux.vnet.ibm.com>
CommitDate: Mon Sep 21 17:04:05 2015 -0500

    e1000: Avoid infinite loop in processing transmit descriptor (CVE-2015-6815)
    
    While processing transmit descriptors, it could lead to an infinite
    loop if 'bytes' was to become zero; Add a check to avoid it.
    
    [The guest can force 'bytes' to 0 by setting the hdr_len and mss
    descriptor fields to 0.
    --Stefan]
    
    Signed-off-by: P J P <pjp@fedoraproject.org>
    Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
    Reviewed-by: Thomas Huth <thuth@redhat.com>
    Message-id: 1441383666-6590-1-git-send-email-stefanha@redhat.com
    (cherry picked from commit b947ac2bf26479e710489739c465c8af336599e7)
    Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

diff --git a/hw/net/e1000.c b/hw/net/e1000.c
index 5c6bcd0014..09c9e9d53b 100644
--- a/hw/net/e1000.c
+++ b/hw/net/e1000.c
@@ -740,7 +740,8 @@ process_tx_desc(E1000State *s, struct e1000_tx_desc *dp)
                 memmove(tp->data, tp->header, tp->hdr_len);
                 tp->size = tp->hdr_len;
             }
-        } while (split_size -= bytes);
+            split_size -= bytes;
+        } while (bytes && split_size);
     } else if (!tp->tse && tp->cptse) {
         // context descriptor TSE is not set, while data descriptor TSE is set
         DBGOUT(TXERR, "TCP segmentation error\n");
